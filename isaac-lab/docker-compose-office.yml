x-common-env: &common_env
  DISPLAY: ${DISPLAY}
  TERM: ${TERM}

x-common-setting: &common_setting
  build:
    context: .
    dockerfile: ./Dockerfile
  image: isaac-lab-ros2-custom
  network_mode: "bridge"
  stdin_open: true
  tty: true
  entrypoint: bash -c "source /opt/ros/jazzy/setup.bash && \
                        source /workspace/IsaacSim-ros_workspaces/jazzy_ws/install/setup.bash && \
                        exec \"$@\"" 
              ros-entrypoint

services:
  isaac_lab_ros2:
    <<: *common_setting
    environment: 
      <<: *common_env
      ACCEPT_EULA: Y
      PRIVACY_CONSENT: Y
    volumes: 
      - ~/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ~/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ~/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ~/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ~/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ~/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /etc/localtime:/etc/localtime
    container_name: isaac-deploy
    deploy:
      resources:
        reservations:
          devices:
             - capabilities: [gpu]
               count: all
    user: 1234:1234
    command: "ros2 launch isaacsim run_isaacsim.launch.py \
                install_path:=/isaac-sim \
                play_sim_on_start:=true \
                gui:=https://omniverse-content-production.s3-us-west-2.amazonaws.com/Assets/Isaac/5.1/Isaac/Samples/ROS2/Scenario/multiple_robot_carter_office_navigation.usd"

  isaac_ros2_ws:
    <<: *common_setting
    environment: *common_env
    volumes: 
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /etc/localtime:/etc/localtime"
    container_name: ros2_ws
    command: "ros2 launch carter_navigation multiple_robot_carter_navigation_office.launch.py"